<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Requisi√ß√µes</title>

  <style>
    :root {
      --cor-fundo: #f9fafb;
      --cor-texto: #111827;
      --cor-botao: #2563eb;
      --cor-botao-vermelho: #dc2626;
      --cor-destaque: #2563eb;
      --cor-cinza-claro: #f3f4f6;
      --cor-card: #ffffff;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; font-family: "Inter", Arial, sans-serif; background: var(--cor-fundo); color: var(--cor-texto); }

    h1 { margin: 0; padding: 15px 0; font-size: 1.8em; font-weight: 700; color: var(--cor-texto); }

    .header-flex {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; background: var(--cor-card); border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .logo-area img { height: 48px; }

    .botoes-acoes { display: flex; gap: 8px; }
    .botoes-acoes button {
      background: var(--cor-botao); color: white; border: none;
      padding: 8px 14px; border-radius: 6px; font-size: 0.9em; cursor: pointer;
      transition: background 0.2s;
    }
    .botoes-acoes button:hover { background: #1d4ed8; }

    .filtros {
      display: flex; flex-wrap: wrap; gap: 10px; padding: 15px 20px;
      background: var(--cor-cinza-claro); border-radius: 8px; margin: 15px;
    }
    .filtros label { display: flex; flex-direction: column; font-size: 0.85em; font-weight: 600; }
    .filtros input, .filtros select {
      padding: 8px; font-size: 1em; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 4px;
    }
    #btnFiltrar {
      background: var(--cor-botao); color: white; border: none; border-radius: 6px;
      padding: 10px 16px; font-size: 0.95em; cursor: pointer; margin-top: auto;
    }
    #btnFiltrar:hover { background: #1d4ed8; }

    .tabela-container {
      max-width: 98%; margin: 20px auto; background: var(--cor-card);
      border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
    thead th { position: sticky; top: 0; background: var(--cor-botao); color: white; padding: 8px; }
    tbody tr:nth-child(even) { background: #f9fafb; }
    tbody tr td { padding: 8px; border-bottom: 1px solid #e5e7eb; }

    .acoes button {
      margin: 2px; padding: 6px 10px; font-size: 0.85em; border: none;
      border-radius: 6px; cursor: pointer; transition: opacity 0.2s;
    }
    .acoes button:hover { opacity: 0.9; }
    .acoes .btn-historico { background: #0ea5e9; color: white; }
    .acoes .btn-neg { background: var(--cor-botao-vermelho); color: white; }
    .acoes .btn-carrinho { background: #6b7280; color: white; }
    .acoes .btn-carrinho.in { background: #16a34a; }

    /* Modais */
    #modalCarrinho, #modalHistorico, #modalAgrupar, #modalAgruparWhatsApp {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:1000;
    }
    .box {
      background:#fff; padding:20px; border-radius:10px;
      width:90vw; max-width:1000px; max-height:90vh; overflow:auto;
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
    }
    .box h3 { margin-top:0; }
    .box table { width:100%; border-collapse:collapse; margin-top:10px; }
    .box th, .box td { border:1px solid #d1d5db; padding:8px; text-align:left; }
    .box th { background:#f3f4f6; }

    @media (max-width: 768px) {
      .header-flex { flex-direction: column; text-align: center; gap: 8px; }
      .botoes-acoes { justify-content: center; flex-wrap: wrap; }
      .filtros { flex-direction: column; }
      table { font-size: 0.85em; }
    }
  </style>
</head>

<body>
  <!-- Cabe√ßalho -->
  <div class="header-flex">
    <div class="logo-area">
      <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo" />
    </div>
    <div class="titulo-area">
      <h1>Painel de Requisi√ß√µes ‚Ä¢ DEL√çCIA GOURMET</h1>
    </div>
    <div class="botoes-acoes">
      <button onclick="abrirModalAgrupar('pdf')">üìö PDF</button>
      <button onclick="abrirModalAgruparWhatsApp()">üì± WhatsApp</button>
      <button onclick="abrirModalAgrupar('print')">üñ®Ô∏è Imprimir</button>
      <button onclick="abrirCarrinho()" title="Ver carrinho">üõí Carrinho</button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filtros">
    <label>Data de:<input type="date" id="filtroDataInicio"></label>
    <label>Hora Inicial:<input type="time" id="filtroHoraInicio"></label>
    <label>Data at√©:<input type="date" id="filtroDataFim"></label>
    <label>Hora Final:<input type="time" id="filtroHoraFim"></label>
    <label>Solicitante:<select id="filtroSolicitante"><option value="">Todos</option></select></label>
    <label>Setor:<select id="filtroSetor"><option value="">Todos</option></select></label>
    <label>Palavra-chave:<input type="text" id="filtroPalavra" placeholder="Buscar item ou observa√ß√£o"></label>
    <button id="btnFiltrar" onclick="filtrar()">üîç Filtrar</button>
  </div>

  <!-- Tabela -->
  <div class="tabela-container">
    <table id="tabelaExport">
      <thead>
        <tr>
          <th>Data e Hora</th><th>Item</th><th>Qtd</th><th>Unidade</th>
          <th>Setor</th><th>Solicitante</th><th>Observa√ß√µes</th><th>Status</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaRequisicoes"></tbody>
    </table>
  </div>

  <!-- Modal Carrinho -->
  <div id="modalCarrinho"><div class="box">
    <h3>üõí Itens no Carrinho</h3>
    <table>
      <thead>
        <tr>
          <th>Item</th><th>C√≥digo</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>Cota√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabelaCarrinhoModal"></tbody>
    </table>
    <br>
    <button onclick="enviarCarrinhoWhatsApp()" style="background:#25d366;color:white;padding:10px 16px;border:none;border-radius:6px;">üì≤ Enviar WhatsApp</button>
    <button onclick="fecharCarrinho()" style="margin-left:10px;padding:10px 16px;background:#e5e7eb;border:none;border-radius:6px;">Fechar</button>
  </div></div>

  <!-- Modal Hist√≥rico -->
  <div id="modalHistorico"><div class="box">
    <h3 id="historicoTitulo">üìà Hist√≥rico de Pre√ßos</h3>
    <table>
      <thead><tr><th>Data</th><th>Fornecedor</th><th>Pre√ßo Unit.</th></tr></thead>
      <tbody id="tabelaHistorico"></tbody>
    </table>
    <br>
    <button onclick="fecharHistorico()" style="padding:10px 16px;background:#e5e7eb;border:none;border-radius:6px;">Fechar</button>
  </div></div>

  <!-- Scripts -->
  <script>
    const URL_DADOS = 'https://script.google.com/macros/s/AKfycbzjVWXyGuwLDEfqNwgJppU2Yvo3_r_L7wbD1-AXfd3lztOUlq5zbKTQ0QCP7IknVae4TA/exec';
    const URL_STATUS = 'https://script.google.com/macros/s/AKfycbxnuFAAJLiThcP99gpgk-EhHIJ2N2YOXjpi7jVROHq6ZqniAkcXlI2h8uj16oTQHsVWnQ/exec';
    const URL_COTACAO = 'https://script.google.com/macros/s/AKfycbxOlPGPAE2W8kLjrXX-ahhfR9ZZQ8Suph9w7UOlBcl3721ttMEBtORKdmEDMdU0_Ven/exec'; // <<<< TROCAR PELO SEU URL

    let carrinhoCompras = JSON.parse(localStorage.getItem("carrinhoCompras") || '[]');
    let requisicoes = [];
    let listaFiltrada = [];

    function toBRDateTime(iso){ try{ return new Date(iso).toLocaleString('pt-BR'); }catch{return iso;} }
    function copiar(texto){ navigator.clipboard.writeText(texto).then(()=>alert('Link copiado!')); }

    function hashCode(str){ let h=0,i=0,len=str.length; while(i<len){ h=((h<<5)-h+str.charCodeAt(i++))|0; } return (h>>>0).toString(36); }
    function extrairCodigoInterno(linha){
      if(linha[8] && String(linha[8]).trim()!=='') return String(linha[8]).trim();
      const obs=(linha[6]||'').toString(); const m=obs.match(/COD:\s*([A-Za-z0-9\-\._]+)/i);
      if(m) return m[1]; return 'AUTO-'+hashCode(String(linha[1])+String(linha[2])+String(linha[3]));
    }

    async function carregarDados(){
      const res=await fetch(URL_DADOS); const dados=await res.json();
      requisicoes=dados.map((l,idx)=>({linha:l.map(c=>(c||'').toString().trim()),idx}))
                       .sort((a,b)=>new Date(a.linha[0])-new Date(b.linha[0]));
      listaFiltrada=[...requisicoes]; renderizarTabela(listaFiltrada); popularFiltros();
    }

    function renderizarTabela(lista){
      const tabela=document.getElementById('tabelaRequisicoes'); tabela.innerHTML='';
      lista.forEach(({linha,idx})=>{
        const tr=document.createElement('tr');
        [0,1,3,2,4,5,6,7].forEach(i=>{
          const td=document.createElement('td'); let v=linha[i];
          if(i===7 && v.toLowerCase()==="processando") v="PENDENTE";
          td.innerHTML=i===0?toBRDateTime(linha[i]):(i===1?`<strong>${linha[i]}</strong>`:v);
          tr.appendChild(td);
        });
        const tdAcoes=document.createElement('td'); tdAcoes.className='acoes';
        // Bot√£o Carrinho
        const btnCarr=document.createElement('button');
        const noCarrinho=carrinhoCompras.some(c=>c.dataHoraOriginal===linha[0] && c.item===linha[1]);
        btnCarr.textContent=noCarrinho?'üõí No carrinho':'‚ûï Carrinho';
        btnCarr.className='btn-carrinho'+(noCarrinho?' in':'');
        btnCarr.onclick=()=>toggleCarrinho(linha,btnCarr); tdAcoes.appendChild(btnCarr);
        // Bot√£o Negar
        const btnNeg=document.createElement('button'); btnNeg.textContent='‚ùå Negar'; btnNeg.className='btn-neg';
        btnNeg.onclick=()=>atualizarStatus(idx,'Negar'); tdAcoes.appendChild(btnNeg);
        // Hist√≥rico
        const btnHist=document.createElement('button'); btnHist.textContent='üìà Hist√≥rico'; btnHist.className='btn-historico';
        btnHist.onclick=()=>abrirModalHistorico(extrairCodigoInterno(linha),linha[1]); tdAcoes.appendChild(btnHist);
        tr.appendChild(tdAcoes); tabela.appendChild(tr);
      });
    }

    async function toggleCarrinho(linha,btn){
      const codigo=extrairCodigoInterno(linha);
      const payload={ action:'registrar_cotacao', produtoCodigo:codigo, produtoNome:linha[1], quantidade:linha[3], unidade:linha[2], setor:linha[4], solicitante:linha[5], observacoes:linha[6]||'', chaveOrigem:linha[0]};
      try{
        const res=await fetch(URL_COTACAO,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
        const out=await res.json(); if(!out.ok) throw new Error(out.error||'Erro');
        carrinhoCompras.push({dataHoraOriginal:linha[0],item:linha[1],unidade:linha[2],quantidade:linha[3],setor:linha[4],solicitante:linha[5],produtoCodigo:codigo,rid:out.rid,cotacaoLink:out.linkCotacao});
        localStorage.setItem("carrinhoCompras",JSON.stringify(carrinhoCompras));
        atualizarCarrinhoModal(); btn.textContent='üõí No carrinho'; btn.className='btn-carrinho in';
      }catch(e){ alert('Erro: '+e.message); }
    }

    function atualizarCarrinhoModal(){
      const tbody=document.getElementById("tabelaCarrinhoModal"); tbody.innerHTML='';
      carrinhoCompras.forEach(item=>{
        const link=item.cotacaoLink?`<a href="${item.cotacaoLink}" target="_blank">Abrir</a> ¬∑ <button onclick="copiar('${item.cotacaoLink.replace(/'/g,"\\'")}')">Copiar</button>`:'‚Äî';
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${item.item}</td><td>${item.produtoCodigo}</td><td>${item.quantidade}</td><td>${item.unidade}</td><td>${item.setor}</td><td>${item.solicitante}</td><td>${link}</td>`;
        tbody.appendChild(tr);
      });
    }
    function abrirCarrinho(){ atualizarCarrinhoModal(); document.getElementById('modalCarrinho').style.display='flex'; }
    function fecharCarrinho(){ document.getElementById('modalCarrinho').style.display='none'; }

    async function abrirModalHistorico(codigo,nome){
      document.getElementById('historicoTitulo').innerText=`üìà Hist√≥rico de Pre√ßos ‚Äî ${nome} (${codigo})`;
      const tbody=document.getElementById('tabelaHistorico'); tbody.innerHTML='<tr><td colspan="3">Carregando...</td></tr>';
      document.getElementById('modalHistorico').style.display='flex';
      try{
        const res=await fetch(`${URL_COTACAO}?action=historico&code=${encodeURIComponent(codigo)}`); const out=await res.json();
        if(!out.ok||!out.items.length){ tbody.innerHTML='<tr><td colspan="3">Sem hist√≥rico.</td></tr>'; return; }
        tbody.innerHTML=''; out.items.forEach(it=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${toBRDateTime(it.data)}</td><td>${it.fornecedor}</td><td>R$ ${Number(it.preco).toFixed(2)}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ tbody.innerHTML=`<tr><td colspan="3" style="color:#b91c1c;">Erro: ${e.message}</td></tr>`; }
    }
    function fecharHistorico(){ document.getElementById('modalHistorico').style.display='none'; }

    carregarDados();
  </script>
</body>
</html>
