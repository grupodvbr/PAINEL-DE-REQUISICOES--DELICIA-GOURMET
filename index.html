<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Requisi√ß√µes</title>
  <style>
    :root {
      --cor-fundo:#f9fafb; --cor-texto:#111827; --cor-botao:#2563eb;
      --cor-botao-vermelho:#dc2626; --cor-cinza-claro:#f3f4f6; --cor-card:#fff;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:"Inter",Arial,sans-serif;background:var(--cor-fundo);color:var(--cor-texto);}
    h1{margin:0;padding:15px 0;font-size:1.6em;font-weight:700;text-align:center;}
    .header-flex{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:var(--cor-card);border-bottom:1px solid #e5e7eb;}
    .logo-area img{height:50px;max-width:180px;object-fit:contain;}
    .botoes-acoes{display:flex;gap:8px}
    .botoes-acoes button{background:var(--cor-botao);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
    .botoes-acoes button:hover{background:#1d4ed8;}
    .filtros{display:flex;flex-wrap:wrap;gap:10px;padding:15px 20px;background:var(--cor-cinza-claro);border-radius:8px;margin:15px;}
    .filtros label{display:flex;flex-direction:column;font-size:.85em;font-weight:600;}
    .filtros input,.filtros select{padding:8px;font-size:1em;border:1px solid #d1d5db;border-radius:6px;margin-top:4px;}
    #btnFiltrar{background:var(--cor-botao);color:#fff;border:none;border-radius:6px;padding:10px 16px;cursor:pointer;}
    #btnFiltrar:hover{background:#1d4ed8;}
    .tabela-container{max-width:98%;margin:20px auto;background:var(--cor-card);border-radius:8px;overflow-x:auto;box-shadow:0 2px 4px rgba(0,0,0,.05);}
    table{width:100%;border-collapse:collapse;font-size:.95em;}
    thead th{background:var(--cor-botao);color:#fff;padding:8px;position:sticky;top:0;}
    tbody td{padding:8px;border-bottom:1px solid #e5e7eb;}
    .acoes button{margin:2px;padding:6px 10px;font-size:.85em;border:none;border-radius:6px;cursor:pointer;}
    .acoes .btn-carrinho{background:#6b7280;color:#fff;}
    .acoes .btn-carrinho.in{background:#16a34a;}
    .acoes .btn-neg{background:#dc2626;color:#fff;}

    /* Modais */
    #modalCarrinho,#modalHistorico,#modalLoading,#modalLiberacoes{
      display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);
      justify-content:center;align-items:center;z-index:1000;
    }
    .box{background:#fff;padding:20px;border-radius:10px;width:90vw;max-width:1000px;max-height:90vh;overflow:auto;}
    .box table{width:100%;border-collapse:collapse;margin-top:10px;}
    .box th,.box td{border:1px solid #d1d5db;padding:8px;text-align:left;}
    .box th{background:#f3f4f6;}
    .loading-box{background:#fff;padding:30px 40px;border-radius:10px;font-size:1.2em;font-weight:bold;}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8em}
    .tag-pendente{background:#fff7ed;border:1px solid #fdba74;color:#9a3412}
    .tag-liberado{background:#ecfdf5;border:1px solid #6ee7b7;color:#065f46}
    .btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
    .btn-ok{background:#10b981;color:#fff}
    .btn-no{background:#ef4444;color:#fff}
    .btn-gray{background:#6b7280;color:#fff}
  </style>
</head>
<body>
  <div class="header-flex">
    <div class="logo-area">
      <!-- üîπ Troque a URL da sua logo -->
      <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo">
    </div>
    <h1>Painel de Requisi√ß√µes ‚Ä¢ DEL√çCIA GOURMET</h1>
    <div class="botoes-acoes">
      <button onclick="abrirLiberacoes()">üîì Solicita√ß√µes</button>
      <button onclick="abrirCarrinho()">üõí Carrinho</button>
    </div>
  </div>

  <div class="filtros">
    <label>Data de:<input type="date" id="filtroDataInicio"></label>
    <label>Hora Inicial:<input type="time" id="filtroHoraInicio"></label>
    <label>Data at√©:<input type="date" id="filtroDataFim"></label>
    <label>Hora Final:<input type="time" id="filtroHoraFim"></label>
    <label>Status:
      <select id="filtroStatus">
        <option value="">Todos</option>
        <option value="pendente">PENDENTE</option>
        <option value="comprar">COMPRAR</option>
        <option value="negar">NEGAR</option>
        <option value="entregue">ENTREGUE</option>
      </select>
    </label>
    <label>Solicitante:<select id="filtroSolicitante"><option value="">Todos</option></select></label>
    <label>Setor:<select id="filtroSetor"><option value="">Todos</option></select></label>
    <label>Palavra:<input type="text" id="filtroPalavra"></label>
    <button id="btnFiltrar" onclick="filtrar()">üîç Filtrar</button>
  </div>

  <div class="tabela-container">
    <table><thead><tr>
      <th>Data</th><th>Item</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>Observa√ß√µes</th><th>Status</th><th>A√ß√µes</th>
    </tr></thead><tbody id="tabelaRequisicoes"></tbody></table>
  </div>

  <!-- Modal Carrinho -->
  <div id="modalCarrinho"><div class="box">
    <h3>üõí Itens no Carrinho</h3>
    <table><thead><tr>
      <th>Item</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>A√ß√£o</th>
    </tr></thead><tbody id="tabelaCarrinhoModal"></tbody></table>

    <div style="margin-top:20px;">
      <button onclick="salvarCarrinhoNaPlanilha()" class="btn btn-ok">üíæ Salvar na Planilha de Cota√ß√µes</button>
      <button onclick="fecharCarrinho()" class="btn btn-gray">Fechar</button>
    </div>
  </div></div>

  <!-- Modal Loading -->
  <div id="modalLoading"><div class="loading-box">‚è≥ Salvando na planilha...</div></div>

  <!-- Modal Solicita√ß√µes de Libera√ß√£o -->
  <div id="modalLiberacoes"><div class="box">
    <h3>üîì Solicita√ß√µes de libera√ß√£o</h3>
    <p id="libInfo" style="margin:6px 0 10px;color:#6b7280">Carregando‚Ä¶</p>
    <table>
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Fornecedor</th>
          <th>Empresa</th>
          <th>Painel</th>
          <th>Status</th>
          <th style="width:220px">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tbodyLiberacoes"></tbody>
    </table>
    <div style="margin-top:14px;text-align:right">
      <button class="btn btn-gray" onclick="fecharLiberacoes()">Fechar</button>
    </div>
  </div></div>

<script>
/* ======== CONFIG ======== */
const EMPRESA = "DEL√çCIA GOURMET";

const URL_DADOS    = "https://script.google.com/macros/s/AKfycbzjVWXyGuwLDEfqNwgJppU2Yvo3_r_L7wbD1-AXfd3lztOUlq5zbKTQ0QCP7IknVae4TA/exec";
const URL_STATUS   = "https://script.google.com/macros/s/AKfycbxnuFAAJLiThcP99gpgk-EhHIJ2N2YOXjpi7jVROHq6ZqniAkcXlI2h8uj16oTQHsVWnQ/exec";
const URL_CARRINHO = "https://script.google.com/macros/s/AKfycbxezSErmLRUVoRUGIbkWictBySxqTFlocyjRQIm9ZybVHOctc7djGqfkI6TUTwu00Dt/exec";

/* GAS de COTA√á√ïES onde est√£o as a√ß√µes de libera√ß√£o (listar_liberacoes/liberar_fornecedor/negar_liberacao) */
const URL_COTACAO  = "https://script.google.com/macros/s/AKfycbzoJWR_CZtaiwMoQ-XrWcVsi5Ww4ACSDH4lvRjMhXZm7VuneTEoBnHMkiK49JSR4Evq/exec";

/* ======== ESTADO ======== */
let carrinho=JSON.parse(localStorage.getItem("carrinhoCompras")||'[]');
let requisicoes=[],listaFiltrada=[];
let liberacoes=[];

/* ======== HELPERS ======== */
function toBRDateTime(iso){ try{ return new Date(iso).toLocaleString('pt-BR'); }catch{return iso;} }
function qs(id){return document.getElementById(id);}

/* ======== DADOS / TABELA ======== */
async function carregarDados(){
  const res=await fetch(URL_DADOS);
  const dados=await res.json();
  requisicoes=dados.map((l,idx)=>({linha:l.map(c=>(c||'').toString().trim()),idx}));
  listaFiltrada=[...requisicoes];
  popularFiltros();
  renderizarTabela(listaFiltrada);
}

function renderizarTabela(lista){
  const tb=qs('tabelaRequisicoes');tb.innerHTML='';
  lista.forEach(({linha,idx})=>{
    const tr=document.createElement('tr');
    [0,1,3,2,4,5,6,7].forEach(i=>{
      const td=document.createElement('td');let v=linha[i];
      if(i===7&&v.toLowerCase()==="processando")v="PENDENTE";
      td.innerHTML=i===0?toBRDateTime(linha[i]):v;tr.appendChild(td);
    });
    const tdA=document.createElement('td');tdA.className='acoes';
    const btnCarr=document.createElement('button');
    const noCarr=carrinho.some(c=>c.dataHoraOriginal===linha[0]&&c.item===linha[1]);
    btnCarr.textContent=noCarr?'üõí':'‚ûï';btnCarr.className='btn-carrinho'+(noCarr?' in':'');
    btnCarr.onclick=()=>addCarrinho(linha,btnCarr);tdA.appendChild(btnCarr);
    const btnNeg=document.createElement('button');btnNeg.textContent='‚ùå';btnNeg.className='btn-neg';
    btnNeg.onclick=()=>atualizarStatus(idx,'Negar');tdA.appendChild(btnNeg);
    tr.appendChild(tdA);tb.appendChild(tr);
  });
}

function addCarrinho(linha,btn){
  carrinho.push({
    dataHoraOriginal:linha[0],
    item:linha[1],
    quantidade:linha[3],
    unidade:linha[2],
    setor:linha[4],
    solicitante:linha[5],
    observacoes:linha[6]||'',
    status:"Comprar"
  });
  localStorage.setItem("carrinhoCompras",JSON.stringify(carrinho));
  atualizarCarrinhoModal();
  btn.textContent='üõí';btn.className='btn-carrinho in';
}

/* ======== CARRINHO ======== */
function atualizarCarrinhoModal(){
  const tb=qs("tabelaCarrinhoModal");tb.innerHTML='';
  carrinho.forEach((it,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${it.item}</td><td>${it.quantidade}</td><td>${it.unidade}</td><td>${it.setor}</td><td>${it.solicitante}</td><td><button onclick="removerDoCarrinho(${idx})">‚ùå</button></td>`;
    tb.appendChild(tr);
  });
}
function removerDoCarrinho(i){carrinho.splice(i,1);localStorage.setItem("carrinhoCompras",JSON.stringify(carrinho));atualizarCarrinhoModal();}
function abrirCarrinho(){atualizarCarrinhoModal();qs('modalCarrinho').style.display='flex';}
function fecharCarrinho(){qs('modalCarrinho').style.display='none';}

async function salvarCarrinhoNaPlanilha(){
  try{
    if(carrinho.length===0){alert("Carrinho vazio!");return;}
    qs('modalLoading').style.display='flex';
    const payload={action:"registrar_carrinho",empresa:EMPRESA,itens:carrinho};
    const res=await fetch(URL_CARRINHO,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(payload)});
    const out=await res.json();
    qs('modalLoading').style.display='none';
    if(!out.ok) throw new Error(out.error||"Falha ao salvar");
    alert(`‚úÖ ${out.count} itens salvos na planilha de cota√ß√µes!`);
    carrinho=[];localStorage.removeItem("carrinhoCompras");atualizarCarrinhoModal();fecharCarrinho();
  }catch(e){
    qs('modalLoading').style.display='none';
    alert("Erro ao salvar: "+e.message);
  }
}

/* ======== FILTROS ======== */
function popularFiltros(){
  const solicitantes=new Set(),setores=new Set();
  requisicoes.forEach(r=>{solicitantes.add(r.linha[5]);setores.add(r.linha[4]);});
  const selS=qs("filtroSolicitante");selS.innerHTML='<option value="">Todos</option>';
  solicitantes.forEach(s=>{if(s){let o=document.createElement("option");o.value=s.toLowerCase();o.textContent=s;selS.appendChild(o);}});
  const selSet=qs("filtroSetor");selSet.innerHTML='<option value="">Todos</option>';
  setores.forEach(s=>{if(s){let o=document.createElement("option");o.value=s.toLowerCase();o.textContent=s;selSet.appendChild(o);}});
}

function filtrar(){
  const inicio=qs("filtroDataInicio").value;
  const fim=qs("filtroDataFim").value;
  const horaIni=qs("filtroHoraInicio").value||"00:00";
  const horaFim=qs("filtroHoraFim").value||"23:59";
  const status=qs("filtroStatus").value.toLowerCase();
  const solicit=qs("filtroSolicitante").value;
  const setor=qs("filtroSetor").value;
  const palavra=qs("filtroPalavra").value.toLowerCase();

  listaFiltrada=requisicoes.filter(r=>{
    const l=r.linha;
    const d=new Date(l[0]);
    if(inicio && d<new Date(`${inicio}T${horaIni}`)) return false;
    if(fim && d>new Date(`${fim}T${horaFim}`)) return false;
    if(status && l[7].toLowerCase()!==status) return false;
    if(solicit && l[5].toLowerCase()!==solicit) return false;
    if(setor && l[4].toLowerCase()!==setor) return false;
    if(palavra && !(l[1].toLowerCase().includes(palavra)||(l[6]||'').toLowerCase().includes(palavra))) return false;
    return true;
  });
  renderizarTabela(listaFiltrada);
}

/* ======== LIBERA√á√ïES ======== */
function abrirLiberacoes(){
  qs('modalLiberacoes').style.display='flex';
  carregarLiberacoes();
}
function fecharLiberacoes(){ qs('modalLiberacoes').style.display='none'; }

async function carregarLiberacoes(){
  qs('libInfo').textContent = 'Carregando‚Ä¶';
  const tb = qs('tbodyLiberacoes'); tb.innerHTML = '';
  try{
    // üëá ajuste o action se no seu GAS for outro nome
    const url = `${URL_COTACAO}?action=listar_liberacoes&empresa=${encodeURIComponent(EMPRESA)}`;
    const r = await fetch(url);
    const j = await r.json();
    if(!j.ok){ throw new Error(j.error||'Falha ao listar'); }
    liberacoes = j.items || [];
    if(liberacoes.length===0){
      qs('libInfo').textContent = 'N√£o h√° solicita√ß√µes pendentes.';
      return;
    }
    qs('libInfo').textContent = `Encontradas ${liberacoes.length} solicita√ß√µes`;
    renderLiberacoes();
  }catch(err){
    qs('libInfo').textContent = 'Erro: ' + err.message;
  }
}

function renderLiberacoes(){
  const tb = qs('tbodyLiberacoes'); tb.innerHTML='';
  liberacoes.forEach((it,idx)=>{
    const statusTag = it.liberado ? '<span class="tag tag-liberado">LIBERADO</span>'
                                  : '<span class="tag tag-pendente">PENDENTE</span>';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${toBRDateTime(it.timestamp || it.ts || new Date())}</td>
      <td>${it.fornecedor || ''}</td>
      <td>${it.empresa || ''}</td>
      <td>${it.painel || ''}</td>
      <td data-col="status">${statusTag}</td>
      <td>
        <button class="btn btn-ok" onclick="liberar(${idx})" ${it.liberado?'disabled':''}>Liberar 1h</button>
        <button class="btn btn-no" onclick="negar(${idx})">Rejeitar</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

async function liberar(idx){
  const req = liberacoes[idx]; if(!req) return;
  try{
    const payload = {
      action: 'liberar_fornecedor',                 // üëà ajuste se necess√°rio
      empresa: req.empresa || EMPRESA,
      fornecedor: req.fornecedor,
      painel: req.painel || '',
      minutos: 60
    };
    const r = await fetch(URL_COTACAO,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'Falha ao liberar');

    liberacoes[idx].liberado = true;
    renderLiberacoes();
  }catch(err){
    alert('Erro ao liberar: ' + err.message);
  }
}

async function negar(idx){
  const req = liberacoes[idx]; if(!req) return;
  if(!confirm(`Rejeitar libera√ß√£o para ${req.fornecedor}?`)) return;
  try{
    const payload = {
      action: 'negar_liberacao',                    // üëà ajuste se necess√°rio
      empresa: req.empresa || EMPRESA,
      fornecedor: req.fornecedor,
      painel: req.painel || ''
    };
    const r = await fetch(URL_COTACAO,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'Falha ao rejeitar');

    liberacoes.splice(idx,1);
    renderLiberacoes();
    if(liberacoes.length===0) qs('libInfo').textContent = 'N√£o h√° solicita√ß√µes pendentes.';
  }catch(err){
    alert('Erro ao rejeitar: ' + err.message);
  }
}

/* ======== STATUS (negado no painel principal) ======== */
async function atualizarStatus(idx, novoStatus){
  const l = requisicoes[idx].linha;
  const payload={action:'atualizar_status',empresa:EMPRESA,dataHoraOriginal:l[0],item:l[1],status:novoStatus};
  try{
    await fetch(URL_STATUS,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    alert("Status atualizado!");
  }catch(e){ alert('Erro: '+e.message); }
}

/* ======== START ======== */
carregarDados();
</script>
</body>
</html>
