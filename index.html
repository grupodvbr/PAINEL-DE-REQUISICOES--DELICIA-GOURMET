<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Requisi√ß√µes</title>
  <style>
    :root {
      --cor-fundo:#f9fafb; --cor-texto:#111827; --cor-botao:#2563eb;
      --cor-botao-vermelho:#dc2626; --cor-cinza-claro:#f3f4f6; --cor-card:#fff;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:"Inter",Arial,sans-serif;background:var(--cor-fundo);color:var(--cor-texto);}
    h1{margin:0;padding:15px 0;font-size:1.6em;font-weight:700;text-align:center;}
    .header-flex{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:var(--cor-card);border-bottom:1px solid #e5e7eb;}
    .logo-area img{height:48px;}
    .botoes-acoes button{background:var(--cor-botao);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
    .botoes-acoes button:hover{background:#1d4ed8;}
    .meta{font-size:.8em;color:#6b7280;margin-left:8px}
    .filtros{display:flex;flex-wrap:wrap;gap:10px;padding:15px 20px;background:var(--cor-cinza-claro);border-radius:8px;margin:15px;}
    .filtros label{display:flex;flex-direction:column;font-size:.85em;font-weight:600;}
    .filtros input,.filtros select{padding:8px;font-size:1em;border:1px solid #d1d5db;border-radius:6px;margin-top:4px;}
    #btnFiltrar{background:var(--cor-botao);color:#fff;border:none;border-radius:6px;padding:10px 16px;cursor:pointer;}
    #btnFiltrar:hover{background:#1d4ed8;}
    .tabela-container{max-width:98%;margin:20px auto;background:var(--cor-card);border-radius:8px;overflow-x:auto;box-shadow:0 2px 4px rgba(0,0,0,.05);}
    table{width:100%;border-collapse:collapse;font-size:.95em;}
    thead th{background:var(--cor-botao);color:#fff;padding:8px;position:sticky;top:0;}
    tbody td{padding:8px;border-bottom:1px solid #e5e7eb;}
    .acoes button{margin:2px;padding:6px 10px;font-size:.85em;border:none;border-radius:6px;cursor:pointer;}
    .acoes .btn-carrinho{background:#6b7280;color:#fff;}
    .acoes .btn-carrinho.in{background:#16a34a;}
    .acoes .btn-neg{background:#dc2626;color:#fff;}
    .acoes .btn-hist{background:#0ea5e9;color:#fff;}
    #modalCarrinho,#modalHistorico{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);justify-content:center;align-items:center;z-index:1000;}
    .box{background:#fff;padding:20px;border-radius:10px;width:90vw;max-width:1000px;max-height:90vh;overflow:auto;}
    .box table{width:100%;border-collapse:collapse;margin-top:10px;}
    .box th,.box td{border:1px solid #d1d5db;padding:8px;text-align:left;}
    .box th{background:#f3f4f6;}
  </style>
</head>
<body>
  <div class="header-flex">
    <div class="logo-area"><img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="logo"></div>
    <h1 id="tituloPainel">Painel de Requisi√ß√µes ‚Ä¢ <span id="empresaSpan">DEL√çCIA GOURMET</span> <span class="meta" id="codigoSpan">(DG-REQ-001)</span></h1>
    <div class="botoes-acoes"><button onclick="abrirCarrinho()">üõí Carrinho</button></div>
  </div>

  <div class="filtros">
    <label>Data de:<input type="date" id="filtroDataInicio"></label>
    <label>Hora Inicial:<input type="time" id="filtroHoraInicio"></label>
    <label>Data at√©:<input type="date" id="filtroDataFim"></label>
    <label>Hora Final:<input type="time" id="filtroHoraFim"></label>
    <label>Solicitante:<select id="filtroSolicitante"><option value="">Todos</option></select></label>
    <label>Setor:<select id="filtroSetor"><option value="">Todos</option></select></label>
    <label>Palavra:<input type="text" id="filtroPalavra"></label>
    <button id="btnFiltrar" onclick="filtrar()">üîç Filtrar</button>
  </div>

  <div class="tabela-container">
    <table><thead><tr>
      <th>Data</th><th>Item</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>Observa√ß√µes</th><th>Status</th><th>A√ß√µes</th>
    </tr></thead><tbody id="tabelaRequisicoes"></tbody></table>
  </div>

  <!-- Modal Carrinho -->
  <div id="modalCarrinho"><div class="box">
    <h3>üõí Itens no Carrinho</h3>
    <table><thead><tr>
      <th>Item</th><th>C√≥digo</th><th>Qtd</th><th>Unidade</th><th>Setor</th><th>Solicitante</th><th>Cota√ß√£o</th><th>A√ß√£o</th>
    </tr></thead><tbody id="tabelaCarrinhoModal"></tbody></table>

    <div id="linksFornecedores" style="margin-top:20px;padding:10px;background:#f3f4f6;border-radius:6px;">
      <h4>üì® Links para fornecedores</h4>
      <ul id="listaLinks"></ul>
    </div>

    <br><button onclick="fecharCarrinho()">Fechar</button>
  </div></div>

  <!-- Modal Hist√≥rico -->
  <div id="modalHistorico"><div class="box">
    <h3 id="historicoTitulo">üìà Hist√≥rico</h3>
    <table><thead><tr><th>Data</th><th>Fornecedor</th><th>Pre√ßo</th></tr></thead><tbody id="tabelaHistorico"></tbody></table>
    <br><button onclick="fecharHistorico()">Fechar</button>
  </div></div>

<script>
/* ===== CONFIG ===== */
let EMPRESA = "DEL√çCIA GOURMET";     // ou passar ?empresa=...
let CODIGO_PAINEL = "DG-REQ-001";    // ou passar ?codigo=... (usado como "painel")

/* Endpoints */
const URL_DADOS   = 'https://script.google.com/macros/s/AKfycbzjVWXyGuwLDEfqNwgJppU2Yvo3_r_L7wbD1-AXfd3lztOUlq5zbKTQ0QCP7IknVae4TA/exec';
const URL_API     = 'https://script.google.com/macros/s/AKfycbznp4DzuAH7_z3Z-azWrdITyEj8IIxNKiwHo-0YipdiEEqoAvqYU178rqSzST7adgsV/exec'; // MESMO para registrar/pendentes/hist√≥rico/atualizar_status

/* Fornecedores padr√£o (edite) */
const FORNECEDORES = ["FornecedorA","FornecedorB","FornecedorC"];

let carrinho = JSON.parse(localStorage.getItem("carrinhoCompras")||'[]');
let requisicoes = [], listaFiltrada = [];

/* ===== Utils ===== */
function qs(k){ return new URLSearchParams(location.search).get(k) || ""; }
function toBRDateTime(iso){ try{ return new Date(iso).toLocaleString('pt-BR'); } catch { return iso; } }
function extrairCodigoInterno(l){ return 'COD-'+btoa((l[1]||'')).replace(/=/g,'').slice(0,8); } // c√≥digo est√°vel a partir do nome
function money(n){ return Number(n).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }

/* Overrides via URL (?empresa=...&codigo=...) */
(function applyOverrides(){
  const emp = qs('empresa'); const cod = qs('codigo');
  if(emp) EMPRESA = emp;
  if(cod) CODIGO_PAINEL = cod;
  document.getElementById('empresaSpan').textContent = EMPRESA;
  document.getElementById('codigoSpan').textContent = `(${CODIGO_PAINEL})`;
})();

/* ===== Dados ===== */
async function carregarDados(){
  const res = await fetch(URL_DADOS);
  const dados = await res.json();
  // Esperado: [data, item, unidade, qtd, setor, solicitante, obs, status, ...]
  requisicoes = (dados||[]).map((l,idx)=>({ linha: (l||[]).map(c=>(c??'').toString().trim()), idx }));
  listaFiltrada = [...requisicoes];
  popularFiltrosBasicos(listaFiltrada);
  renderizarTabela(listaFiltrada);
}

function popularFiltrosBasicos(lista){
  const selSol = document.getElementById('filtroSolicitante');
  const selSet = document.getElementById('filtroSetor');
  const sols = new Set(), sets = new Set();
  lista.forEach(({linha})=>{ sols.add(linha[5]||""); sets.add(linha[4]||""); });
  [...sols].filter(Boolean).sort().forEach(v=>{
    const o=document.createElement('option');o.value=v;o.textContent=v;selSol.appendChild(o);
  });
  [...sets].filter(Boolean).sort().forEach(v=>{
    const o=document.createElement('option');o.value=v;o.textContent=v;selSet.appendChild(o);
  });
}

function filtrar(){
  const di = document.getElementById('filtroDataInicio').value;
  const hi = document.getElementById('filtroHoraInicio').value;
  const df = document.getElementById('filtroDataFim').value;
  const hf = document.getElementById('filtroHoraFim').value;
  const solicit = document.getElementById('filtroSolicitante').value.toLowerCase();
  const setor = document.getElementById('filtroSetor').value.toLowerCase();
  const palavra = document.getElementById('filtroPalavra').value.toLowerCase();

  const inicio = di ? new Date(`${di}T${hi||'00:00'}`) : null;
  const fim    = df ? new Date(`${df}T${hf||'23:59'}`) : null;

  listaFiltrada = requisicoes.filter(({linha})=>{
    const dt = new Date(linha[0]);
    if(inicio && dt < inicio) return false;
    if(fim && dt > fim) return false;
    if(solicit && !(linha[5]||"").toLowerCase().includes(solicit)) return false;
    if(setor && !(linha[4]||"").toLowerCase().includes(setor)) return false;
    const texto = (linha.join(' ')||"").toLowerCase();
    if(palavra && !texto.includes(palavra)) return false;
    return true;
  });
  renderizarTabela(listaFiltrada);
}

function renderizarTabela(lista){
  const tb = document.getElementById('tabelaRequisicoes'); tb.innerHTML='';
  lista.forEach(({linha,idx})=>{
    const tr=document.createElement('tr');
    [0,1,3,2,4,5,6,7].forEach(i=>{
      const td=document.createElement('td'); let v = linha[i];
      if(i===7 && (v||"").toLowerCase()==="processando") v="PENDENTE";
      td.innerHTML = (i===0 ? toBRDateTime(linha[i]) : v);
      tr.appendChild(td);
    });
    const tdA=document.createElement('td'); tdA.className='acoes';
    const btnCarr=document.createElement('button');
    const noCarr=carrinho.some(c=>c.dataHoraOriginal===linha[0]&&c.item===linha[1]);
    btnCarr.textContent=noCarr?'üõí':'‚ûï'; btnCarr.className='btn-carrinho'+(noCarr?' in':'');
    btnCarr.onclick=()=>addCarrinho(linha,btnCarr); tdA.appendChild(btnCarr);
    const btnNeg=document.createElement('button'); btnNeg.textContent='‚ùå'; btnNeg.className='btn-neg';
    btnNeg.onclick=()=>atualizarStatus(idx,'Negar'); tdA.appendChild(btnNeg);
    const btnHist=document.createElement('button'); btnHist.textContent='üìà'; btnHist.className='btn-hist';
    btnHist.onclick=()=>abrirModalHistorico(extrairCodigoInterno(linha),linha[1]); tdA.appendChild(btnHist);
    tr.appendChild(tdA);tb.appendChild(tr);
  });
}

/* ===== Carrinho / Cota√ß√µes ===== */
async function addCarrinho(linha,btn){
  const codigo = extrairCodigoInterno(linha);
  const payload = {
    action: 'registrar_cotacao',
    empresa: EMPRESA,
    painelCodigo: CODIGO_PAINEL,
    produtoCodigo: codigo,
    produtoNome: linha[1],
    quantidade: linha[3],
    unidade: linha[2],
    setor: linha[4],
    solicitante: linha[5],
    observacoes: linha[6] || '',
    chaveOrigem: linha[0]
  };
  const res = await fetch(URL_API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const out = await res.json();
  if(!out.ok) return alert("Erro: "+(out.error||'Falha ao registrar'));
  carrinho.push({
    dataHoraOriginal: linha[0], item: linha[1], quantidade: linha[3], unidade: linha[2],
    setor: linha[4], solicitante: linha[5], produtoCodigo: codigo,
    rid: out.rid, cotacaoLink: out.linkCotacao, empresa: EMPRESA, painelCodigo: CODIGO_PAINEL
  });
  localStorage.setItem("carrinhoCompras", JSON.stringify(carrinho));
  atualizarCarrinhoModal();
  btn.textContent='üõí'; btn.className='btn-carrinho in';
}

function atualizarCarrinhoModal(){
  const tb=document.getElementById("tabelaCarrinhoModal"); tb.innerHTML='';
  carrinho.forEach((it,idx)=>{
    const link=it.cotacaoLink?`<a href="${it.cotacaoLink}" target="_blank">Abrir</a>`:'‚Äî';
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${it.item}</td><td>${it.produtoCodigo}</td><td>${it.quantidade}</td><td>${it.unidade}</td><td>${it.setor}</td><td>${it.solicitante}</td><td>${link}</td><td><button onclick="removerDoCarrinho(${idx})">‚ùå</button></td>`;
    tb.appendChild(tr);
  });
  const ul=document.getElementById("listaLinks"); ul.innerHTML="";
  if(carrinho.length>0){
    FORNECEDORES.forEach(f=>{
      const url=`index.fornecedor.html?empresa=${encodeURIComponent(EMPRESA)}&painel=${encodeURIComponent(CODIGO_PAINEL)}&fornecedor=${encodeURIComponent(f)}`;
      const li=document.createElement("li"); li.innerHTML=`<a href="${url}" target="_blank">${f}</a>`; ul.appendChild(li);
    });
  } else {
    ul.innerHTML="<li><em>Carrinho vazio</em></li>";
  }
}
function removerDoCarrinho(i){carrinho.splice(i,1);localStorage.setItem("carrinhoCompras", JSON.stringify(carrinho));atualizarCarrinhoModal();}
function abrirCarrinho(){atualizarCarrinhoModal();document.getElementById('modalCarrinho').style.display='flex';}
function fecharCarrinho(){document.getElementById('modalCarrinho').style.display='none';}

/* ===== Hist√≥rico ===== */
async function abrirModalHistorico(cod,nome){
  document.getElementById('historicoTitulo').innerText=`Hist√≥rico - ${nome} (${cod})`;
  const tb=document.getElementById('tabelaHistorico'); tb.innerHTML='<tr><td colspan=3>Carregando...</td></tr>';
  document.getElementById('modalHistorico').style.display='flex';
  const url = `${URL_API}?action=historico&code=${encodeURIComponent(cod)}&empresa=${encodeURIComponent(EMPRESA)}&painel=${encodeURIComponent(CODIGO_PAINEL)}`;
  const res=await fetch(url); const out=await res.json();
  tb.innerHTML='';
  if(!out.ok || !out.items || !out.items.length){
    tb.innerHTML='<tr><td colspan=3>Sem hist√≥rico</td></tr>'; return;
  }
  out.items.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${toBRDateTime(it.data)}</td><td>${it.fornecedor}</td><td>R$ ${money(it.preco)}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== Status ===== */
async function atualizarStatus(idx, novoStatus){
  const l = requisicoes[idx].linha;
  const payload = {
    action: 'atualizar_status',
    empresa: EMPRESA,
    painelCodigo: CODIGO_PAINEL,
    dataHoraOriginal: l[0],
    item: l[1],
    status: novoStatus
  };
  try{
    const res = await fetch(URL_API, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const out = await res.json();
    if(!out.ok) throw new Error(out.error || 'Falha ao atualizar status.');
    l[7] = novoStatus;
    renderizarTabela(listaFiltrada);
  }catch(e){ alert("Erro ao atualizar: " + e.message); }
}

/* Boot */
carregarDados();
</script>
</body>
</html>
