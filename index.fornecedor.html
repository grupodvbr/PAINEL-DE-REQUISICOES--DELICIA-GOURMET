<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Responder Cota√ß√£o</title>
<style>
  body{font-family:"Inter",Arial,sans-serif;background:#f9fafb;margin:0;padding:20px;}
  .box{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
  h1{text-align:center;}
  table{width:100%;border-collapse:collapse;margin-top:15px;}
  th,td{border:1px solid #ddd;padding:8px;}
  th{background:#2563eb;color:#fff;}
  input,button{padding:8px;width:100%;border:1px solid #ccc;border-radius:6px;}
  button{background:#2563eb;color:#fff;cursor:pointer;margin-top:10px;}
  button:hover{background:#1d4ed8;}
</style>
</head>
<body>
<h1 id="titulo">Responder Cota√ß√£o</h1>
<div class="box">
  <p id="info"></p>
  <table>
    <thead><tr><th>Produto</th><th>Qtd</th><th>Unid</th><th>Pre√ßo Unit.</th><th>Obs</th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
  <button onclick="enviar()">üì§ Enviar Respostas</button>
</div>
<script>
const URL_COTACAO="https://script.google.com/macros/s/AKfycbxOlPGPAE2W8kLjrXX-ahhfR9ZZQ8Suph9w7UOlBcl3721ttMEBtORKdmEDMdU0_Ven/exec";
let fornecedor="",dataCotacao="",itens=[];

window.onload=async()=>{
  const p=new URLSearchParams(window.location.search);
  fornecedor=p.get("fornecedor"); dataCotacao=p.get("date");
  document.getElementById("titulo").innerText=`Responder Cota√ß√£o - ${fornecedor}`;
  document.getElementById("info").innerText=`Data da Cota√ß√£o: ${dataCotacao}`;
  await carregarItens(dataCotacao);
};

async function carregarItens(data){
  try{
    const res=await fetch(`${URL_COTACAO}?action=itensPorData&date=${encodeURIComponent(data)}`);
    const out=await res.json();
    if(!out.ok||!out.items.length){document.getElementById("tbody").innerHTML="<tr><td colspan=5>Sem itens</td></tr>";return;}
    itens=out.items;
    render();
  }catch(e){alert("Erro ao carregar: "+e.message);}
}

function render(){
  const tb=document.getElementById("tbody");tb.innerHTML="";
  itens.forEach(it=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${it.produto}</td>
      <td>${it.quantidade}</td>
      <td>${it.unidade}</td>
      <td><input type="number" step="0.01" data-codigo="${it.codigo}" data-rid="${it.rid}"></td>
      <td><input type="text"></td>`;
    tb.appendChild(tr);
  });
}

async function enviar(){
  const linhas=document.querySelectorAll("#tbody tr");
  for(const ln of linhas){
    const preco=ln.querySelector("input[type=number]").value;
    const obs=ln.querySelector("input[type=text]").value;
    const rid=ln.querySelector("input[type=number]").dataset.rid;
    const codigo=ln.querySelector("input[type=number]").dataset.codigo;
    if(!preco)continue;
    const payload={action:"enviar_resposta",rid,produtoCodigo:codigo,fornecedor,preco,observacoes:obs};
    await fetch(URL_COTACAO,{method:"POST",headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
  }
  alert("Respostas enviadas com sucesso!");
}
</script>
</body>
</html>
