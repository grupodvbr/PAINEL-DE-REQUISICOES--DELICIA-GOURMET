<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Responder Cota√ß√£o</title>
<style>
  body{font-family:"Inter",Arial,sans-serif;background:#f9fafb;margin:0;padding:20px;}
  .box{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
  h1{text-align:center;}
  table{width:100%;border-collapse:collapse;margin-top:15px;}
  th,td{border:1px solid #ddd;padding:8px;}
  th{background:#2563eb;color:#fff;}
  input,button{padding:8px;border:1px solid #ccc;border-radius:6px;}
  input[type=number]{width:120px;}
  input[type=text]{width:100%;}
  button{background:#2563eb;color:#fff;cursor:pointer;margin-top:15px;width:100%;font-size:1em;}
  button:hover{background:#1d4ed8;}
</style>
</head>
<body>
<h1 id="titulo">Responder Cota√ß√£o</h1>
<div class="box">
  <p id="info">Exibindo todas as cota√ß√µes pendentes</p>
  <table>
    <thead>
      <tr>
        <th>Produto</th><th>Qtd</th><th>Unid</th><th>Pre√ßo Unit.</th><th>Obs</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <button onclick="enviar()">üì§ Enviar Respostas</button>
</div>

<script>
const URL_COTACAO = "https://script.google.com/macros/s/AKfycbwurdFQJS_P94ETlWe4z6X-uERRGBGXL9OzdGj2xGP-o7oiGSY-E2FEnNdiTsQT0wFs/exec"; // troque pelo seu WebApp URL
let fornecedor = "", itens = [];

window.onload = async ()=>{
  const p = new URLSearchParams(window.location.search);
  fornecedor = p.get("fornecedor") || "FORNECEDOR";
  document.getElementById("titulo").innerText = `Responder Cota√ß√£o - ${fornecedor}`;
  await carregarItens();
};

async function carregarItens(){
  try{
    const res = await fetch(`${URL_COTACAO}?action=itenspendentes`);
    const out = await res.json();
    if(!out.ok || !out.items.length){
      document.getElementById("tbody").innerHTML = "<tr><td colspan=5>‚úÖ Nenhuma cota√ß√£o pendente</td></tr>";
      return;
    }
    itens = out.items;
    render();
  }catch(e){ alert("Erro ao carregar itens: "+e.message); }
}

function render(){
  const tb = document.getElementById("tbody"); tb.innerHTML = "";
  itens.forEach(it=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${it.produto}</td>
      <td>${it.quantidade}</td>
      <td>${it.unidade}</td>
      <td><input type="number" step="0.01" placeholder="0,00" data-rid="${it.rid}" data-codigo="${it.codigo}" data-produto="${it.produto}"></td>
      <td><input type="text" placeholder="Observa√ß√£o"></td>
    `;
    tb.appendChild(tr);
  });
}

async function enviar(){
  const linhas = document.querySelectorAll("#tbody tr");
  let enviados = 0;
  for(const ln of linhas){
    const preco = ln.querySelector("input[type=number]")?.value;
    const obs = ln.querySelector("input[type=text]")?.value;
    const input = ln.querySelector("input[type=number]");
    if(!input) continue;

    const rid = input.dataset.rid;
    const codigo = input.dataset.codigo;
    const produto = input.dataset.produto;

    if(!preco) continue;

    const payload = {
      action: "enviar_resposta",
      rid,
      produtoCodigo: codigo,
      produtoNome: produto,
      fornecedor,
      preco,
      observacoes: obs
    };

    try{
      const res = await fetch(URL_COTACAO, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const out = await res.json();
      if(out.ok) enviados++;
    }catch(e){
      console.error("Erro ao enviar:", e);
    }
  }
  alert(`‚úÖ ${enviados} respostas registradas para ${fornecedor}`);
}
</script>
</body>
</html>
